# Improve response times 10x by introducing an interceptor in NestJS


`autocannon -d 10 -c 10 http://127.0.0.1:3000/before`

`autocannon -d 10 -c 10 http://127.0.0.1:3000/after`

## 5ms delay on a job 

┌─────────┬──────┬──────┬───────┬───────┬─────────┬─────────┬───────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%   │ Avg     │ Stdev   │ Max   │
├─────────┼──────┼──────┼───────┼───────┼─────────┼─────────┼───────┤
│ Latency │ 5 ms │ 7 ms │ 14 ms │ 18 ms │ 7.41 ms │ 3.01 ms │ 58 ms │
└─────────┴──────┴──────┴───────┴───────┴─────────┴─────────┴───────┘
┌───────────┬────────┬────────┬────────┬────────┬────────┬─────────┬────────┐
│ Stat      │ 1%     │ 2.5%   │ 50%    │ 97.5%  │ Avg    │ Stdev   │ Min    │
├───────────┼────────┼────────┼────────┼────────┼────────┼─────────┼────────┤
│ Req/Sec   │ 1080   │ 1080   │ 1264   │ 1364   │ 1247   │ 88.52   │ 1080   │
├───────────┼────────┼────────┼────────┼────────┼────────┼─────────┼────────┤
│ Bytes/Sec │ 258 kB │ 258 kB │ 302 kB │ 326 kB │ 298 kB │ 21.2 kB │ 258 kB │
└───────────┴────────┴────────┴────────┴────────┴────────┴─────────┴────────┘
12k requests in 10.02s, 2.98 MB read




┌─────────┬──────┬──────┬───────┬──────┬─────────┬─────────┬───────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%  │ Avg     │ Stdev   │ Max   │
├─────────┼──────┼──────┼───────┼──────┼─────────┼─────────┼───────┤
│ Latency │ 1 ms │ 1 ms │ 5 ms  │ 7 ms │ 1.48 ms │ 1.31 ms │ 33 ms │
└─────────┴──────┴──────┴───────┴──────┴─────────┴─────────┴───────┘
┌───────────┬────────┬────────┬─────────┬─────────┬─────────┬────────┬────────┐
│ Stat      │ 1%     │ 2.5%   │ 50%     │ 97.5%   │ Avg     │ Stdev  │ Min    │
├───────────┼────────┼────────┼─────────┼─────────┼─────────┼────────┼────────┤
│ Req/Sec   │ 3135   │ 3135   │ 5159    │ 5775    │ 4997    │ 812.14 │ 3135   │
├───────────┼────────┼────────┼─────────┼─────────┼─────────┼────────┼────────┤
│ Bytes/Sec │ 750 kB │ 750 kB │ 1.23 MB │ 1.38 MB │ 1.19 MB │ 194 kB │ 749 kB │
└───────────┴────────┴────────┴─────────┴─────────┴─────────┴────────┴────────┘
50k requests in 10.01s, 11.9 MB read


## 25ms delay on a job 

┌─────────┬───────┬───────┬───────┬───────┬─────────┬──────────┬────────┐
│ Stat    │ 2.5%  │ 50%   │ 97.5% │ 99%   │ Avg     │ Stdev    │ Max    │
├─────────┼───────┼───────┼───────┼───────┼─────────┼──────────┼────────┤
│ Latency │ 26 ms │ 29 ms │ 43 ms │ 50 ms │ 31.9 ms │ 15.49 ms │ 210 ms │
└─────────┴───────┴───────┴───────┴───────┴─────────┴──────────┴────────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬───────┬─────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg   │ Stdev   │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼───────┼─────────┼─────────┤
│ Req/Sec   │ 260     │ 260     │ 315     │ 335     │ 309.5 │ 25.63   │ 260     │
├───────────┼─────────┼─────────┼─────────┼─────────┼───────┼─────────┼─────────┤
│ Bytes/Sec │ 62.1 kB │ 62.1 kB │ 75.3 kB │ 80.1 kB │ 74 kB │ 6.13 kB │ 62.1 kB │
└───────────┴─────────┴─────────┴─────────┴─────────┴───────┴─────────┴─────────┘
3k requests in 10.04s, 740 kB read


┌─────────┬──────┬──────┬───────┬──────┬────────┬─────────┬───────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%  │ Avg    │ Stdev   │ Max   │
├─────────┼──────┼──────┼───────┼──────┼────────┼─────────┼───────┤
│ Latency │ 1 ms │ 1 ms │ 3 ms  │ 5 ms │ 1.3 ms │ 0.79 ms │ 16 ms │
└─────────┴──────┴──────┴───────┴──────┴────────┴─────────┴───────┘
┌───────────┬────────┬────────┬─────────┬─────────┬─────────┬────────┬────────┐
│ Stat      │ 1%     │ 2.5%   │ 50%     │ 97.5%   │ Avg     │ Stdev  │ Min    │
├───────────┼────────┼────────┼─────────┼─────────┼─────────┼────────┼────────┤
│ Req/Sec   │ 3507   │ 3507   │ 5815    │ 5939    │ 5483.55 │ 715.52 │ 3506   │
├───────────┼────────┼────────┼─────────┼─────────┼─────────┼────────┼────────┤
│ Bytes/Sec │ 838 kB │ 838 kB │ 1.39 MB │ 1.42 MB │ 1.31 MB │ 171 kB │ 838 kB │
└───────────┴────────┴────────┴─────────┴─────────┴─────────┴────────┴────────┘
60k requests in 11.01s, 14.4 MB read


## test with redis real queue

first run redis with persistence
`docker run -p 6379:6379 --name redis -d redis --save 60 1 --loglevel warning`

stop service
`docker stop redis`

start service
`docker start redis`

copy env values
`cp .env.example .env`

fill in your redis credentials if they are not `localhost:6379`