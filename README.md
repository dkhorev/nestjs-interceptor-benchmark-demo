# Improve response times 10x by introducing an interceptor in NestJS


`autocannon -d 10 -c 10 http://127.0.0.1:3000/before`

`autocannon -d 10 -c 10 http://127.0.0.1:3000/after`

## 5ms delay on a job 

┌─────────┬──────┬──────┬───────┬───────┬─────────┬─────────┬───────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%   │ Avg     │ Stdev   │ Max   │
├─────────┼──────┼──────┼───────┼───────┼─────────┼─────────┼───────┤
│ Latency │ 5 ms │ 7 ms │ 14 ms │ 18 ms │ 7.41 ms │ 3.01 ms │ 58 ms │
└─────────┴──────┴──────┴───────┴───────┴─────────┴─────────┴───────┘
┌───────────┬────────┬────────┬────────┬────────┬────────┬─────────┬────────┐
│ Stat      │ 1%     │ 2.5%   │ 50%    │ 97.5%  │ Avg    │ Stdev   │ Min    │
├───────────┼────────┼────────┼────────┼────────┼────────┼─────────┼────────┤
│ Req/Sec   │ 1080   │ 1080   │ 1264   │ 1364   │ 1247   │ 88.52   │ 1080   │
├───────────┼────────┼────────┼────────┼────────┼────────┼─────────┼────────┤
│ Bytes/Sec │ 258 kB │ 258 kB │ 302 kB │ 326 kB │ 298 kB │ 21.2 kB │ 258 kB │
└───────────┴────────┴────────┴────────┴────────┴────────┴─────────┴────────┘
12k requests in 10.02s, 2.98 MB read




┌─────────┬──────┬──────┬───────┬──────┬─────────┬─────────┬───────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%  │ Avg     │ Stdev   │ Max   │
├─────────┼──────┼──────┼───────┼──────┼─────────┼─────────┼───────┤
│ Latency │ 1 ms │ 1 ms │ 5 ms  │ 7 ms │ 1.48 ms │ 1.31 ms │ 33 ms │
└─────────┴──────┴──────┴───────┴──────┴─────────┴─────────┴───────┘
┌───────────┬────────┬────────┬─────────┬─────────┬─────────┬────────┬────────┐
│ Stat      │ 1%     │ 2.5%   │ 50%     │ 97.5%   │ Avg     │ Stdev  │ Min    │
├───────────┼────────┼────────┼─────────┼─────────┼─────────┼────────┼────────┤
│ Req/Sec   │ 3135   │ 3135   │ 5159    │ 5775    │ 4997    │ 812.14 │ 3135   │
├───────────┼────────┼────────┼─────────┼─────────┼─────────┼────────┼────────┤
│ Bytes/Sec │ 750 kB │ 750 kB │ 1.23 MB │ 1.38 MB │ 1.19 MB │ 194 kB │ 749 kB │
└───────────┴────────┴────────┴─────────┴─────────┴─────────┴────────┴────────┘
50k requests in 10.01s, 11.9 MB read


## 25ms delay on a job 

┌─────────┬───────┬───────┬───────┬───────┬─────────┬──────────┬────────┐
│ Stat    │ 2.5%  │ 50%   │ 97.5% │ 99%   │ Avg     │ Stdev    │ Max    │
├─────────┼───────┼───────┼───────┼───────┼─────────┼──────────┼────────┤
│ Latency │ 26 ms │ 29 ms │ 43 ms │ 50 ms │ 31.9 ms │ 15.49 ms │ 210 ms │
└─────────┴───────┴───────┴───────┴───────┴─────────┴──────────┴────────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬───────┬─────────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg   │ Stdev   │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼───────┼─────────┼─────────┤
│ Req/Sec   │ 260     │ 260     │ 315     │ 335     │ 309.5 │ 25.63   │ 260     │
├───────────┼─────────┼─────────┼─────────┼─────────┼───────┼─────────┼─────────┤
│ Bytes/Sec │ 62.1 kB │ 62.1 kB │ 75.3 kB │ 80.1 kB │ 74 kB │ 6.13 kB │ 62.1 kB │
└───────────┴─────────┴─────────┴─────────┴─────────┴───────┴─────────┴─────────┘
3k requests in 10.04s, 740 kB read


┌─────────┬──────┬──────┬───────┬──────┬────────┬─────────┬───────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%  │ Avg    │ Stdev   │ Max   │
├─────────┼──────┼──────┼───────┼──────┼────────┼─────────┼───────┤
│ Latency │ 1 ms │ 1 ms │ 3 ms  │ 5 ms │ 1.3 ms │ 0.79 ms │ 16 ms │
└─────────┴──────┴──────┴───────┴──────┴────────┴─────────┴───────┘
┌───────────┬────────┬────────┬─────────┬─────────┬─────────┬────────┬────────┐
│ Stat      │ 1%     │ 2.5%   │ 50%     │ 97.5%   │ Avg     │ Stdev  │ Min    │
├───────────┼────────┼────────┼─────────┼─────────┼─────────┼────────┼────────┤
│ Req/Sec   │ 3507   │ 3507   │ 5815    │ 5939    │ 5483.55 │ 715.52 │ 3506   │
├───────────┼────────┼────────┼─────────┼─────────┼─────────┼────────┼────────┤
│ Bytes/Sec │ 838 kB │ 838 kB │ 1.39 MB │ 1.42 MB │ 1.31 MB │ 171 kB │ 838 kB │
└───────────┴────────┴────────┴─────────┴─────────┴─────────┴────────┴────────┘
60k requests in 11.01s, 14.4 MB read


## test with redis real queue

first run redis with persistence
`docker run -p 6379:6379 --name redis -d redis --save 60 1 --loglevel warning`

stop service
`docker stop redis`

start service
`docker start redis`

copy env values
`cp .env.example .env`

fill in your redis credentials if they are not `localhost:6379`

### before

┌─────────┬──────┬──────┬───────┬──────┬─────────┬─────────┬───────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%  │ Avg     │ Stdev   │ Max   │
├─────────┼──────┼──────┼───────┼──────┼─────────┼─────────┼───────┤
│ Latency │ 1 ms │ 2 ms │ 4 ms  │ 6 ms │ 1.66 ms │ 1.02 ms │ 18 ms │
└─────────┴──────┴──────┴───────┴──────┴─────────┴─────────┴───────┘
┌───────────┬────────┬────────┬─────────┬─────────┬─────────┬─────────┬────────┐
│ Stat      │ 1%     │ 2.5%   │ 50%     │ 97.5%   │ Avg     │ Stdev   │ Min    │
├───────────┼────────┼────────┼─────────┼─────────┼─────────┼─────────┼────────┤
│ Req/Sec   │ 3665   │ 3665   │ 4547    │ 4887    │ 4459.11 │ 349.09  │ 3664   │
├───────────┼────────┼────────┼─────────┼─────────┼─────────┼─────────┼────────┤
│ Bytes/Sec │ 876 kB │ 876 kB │ 1.09 MB │ 1.17 MB │ 1.07 MB │ 83.2 kB │ 876 kB │
└───────────┴────────┴────────┴─────────┴─────────┴─────────┴─────────┴────────┘
45k requests in 10.01s, 10.7 MB read

### after (worse - interceptor ?)

┌─────────┬──────┬──────┬───────┬──────┬─────────┬─────────┬───────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%  │ Avg     │ Stdev   │ Max   │
├─────────┼──────┼──────┼───────┼──────┼─────────┼─────────┼───────┤
│ Latency │ 2 ms │ 2 ms │ 4 ms  │ 6 ms │ 2.36 ms │ 1.05 ms │ 20 ms │
└─────────┴──────┴──────┴───────┴──────┴─────────┴─────────┴───────┘
┌───────────┬────────┬────────┬────────┬────────┬────────┬─────────┬────────┐
│ Stat      │ 1%     │ 2.5%   │ 50%    │ 97.5%  │ Avg    │ Stdev   │ Min    │
├───────────┼────────┼────────┼────────┼────────┼────────┼─────────┼────────┤
│ Req/Sec   │ 3415   │ 3415   │ 3715   │ 3857   │ 3691.2 │ 123.15  │ 3415   │
├───────────┼────────┼────────┼────────┼────────┼────────┼─────────┼────────┤
│ Bytes/Sec │ 817 kB │ 817 kB │ 888 kB │ 922 kB │ 882 kB │ 29.4 kB │ 816 kB │
└───────────┴────────┴────────┴────────┴────────┴────────┴─────────┴────────┘
37k requests in 10.01s, 8.82 MB read


## test with remote redis connection (EU to EU)

`autocannon -d 60 -c 10 http://127.0.0.1:3000/redis/before`

`autocannon -d 60 -c 10 http://127.0.0.1:3000/redis/after`

### before

┌─────────┬───────┬───────┬───────┬───────┬──────────┬─────────┬───────┐
│ Stat    │ 2.5%  │ 50%   │ 97.5% │ 99%   │ Avg      │ Stdev   │ Max   │
├─────────┼───────┼───────┼───────┼───────┼──────────┼─────────┼───────┤
│ Latency │ 63 ms │ 64 ms │ 71 ms │ 75 ms │ 64.36 ms │ 2.02 ms │ 79 ms │
└─────────┴───────┴───────┴───────┴───────┴──────────┴─────────┴───────┘
┌───────────┬─────────┬─────────┬─────────┬─────────┬─────────┬───────┬─────────┐
│ Stat      │ 1%      │ 2.5%    │ 50%     │ 97.5%   │ Avg     │ Stdev │ Min     │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼───────┼─────────┤
│ Req/Sec   │ 149     │ 149     │ 153     │ 157     │ 153.6   │ 2.58  │ 149     │
├───────────┼─────────┼─────────┼─────────┼─────────┼─────────┼───────┼─────────┤
│ Bytes/Sec │ 35.6 kB │ 35.6 kB │ 36.6 kB │ 37.5 kB │ 36.7 kB │ 618 B │ 35.6 kB │
└───────────┴─────────┴─────────┴─────────┴─────────┴─────────┴───────┴─────────┘
2k requests in 10.03s, 367 kB read


### after

┌─────────┬──────┬──────┬───────┬──────┬─────────┬─────────┬───────┐
│ Stat    │ 2.5% │ 50%  │ 97.5% │ 99%  │ Avg     │ Stdev   │ Max   │
├─────────┼──────┼──────┼───────┼──────┼─────────┼─────────┼───────┤
│ Latency │ 1 ms │ 2 ms │ 6 ms  │ 8 ms │ 2.09 ms │ 1.62 ms │ 30 ms │
└─────────┴──────┴──────┴───────┴──────┴─────────┴─────────┴───────┘
┌───────────┬────────┬────────┬────────┬─────────┬────────┬────────┬────────┐
│ Stat      │ 1%     │ 2.5%   │ 50%    │ 97.5%   │ Avg    │ Stdev  │ Min    │
├───────────┼────────┼────────┼────────┼─────────┼────────┼────────┼────────┤
│ Req/Sec   │ 2281   │ 2281   │ 4143   │ 4527    │ 3866.8 │ 725.31 │ 2281   │
├───────────┼────────┼────────┼────────┼─────────┼────────┼────────┼────────┤
│ Bytes/Sec │ 545 kB │ 545 kB │ 990 kB │ 1.08 MB │ 924 kB │ 173 kB │ 545 kB │
└───────────┴────────┴────────┴────────┴─────────┴────────┴────────┴────────┘
39k requests in 10.02s, 9.24 MB read